language: node_js

node_js:
  - 12

notifications:
  email: false

branches:
  only:
    - main

script:
  - echo "test if deploy"
  - LATEST_COMMIT=$(git log -1 --format=format:%H --full-diff .)
  - LATEST_APP_COMMIT=$(git log -1 --format=format:%H --full-diff ./captcha-service/app)
  - |
    if [[ $LATEST_COMMIT == $LATEST_APP_COMMIT ]]
    then
      echo "Deploy App"
      # DEPLOY_APP=true
    fi

after_script:
  - |
    if [[ $DEPLOY_APP = true ]]
    then
      echo "Deploying App"

      git config user.name $GHUSER
      git config user.email $GHEMAIL

      git checkout --orphan gh-pages
      git rm --cached -rf .

      mv captcha-service/app/* .
      rm -rf 1984 captcha-service

      git add index.html index.css fonts js
      git commit -m "update site"
      git remote add origin-pages https://thiagohersan:$GHTOKEN@github.com/thiagohersan/captcha-ocr.git
      git push origin-pages :gh-pages
      git push -u origin-pages gh-pages
    fi
